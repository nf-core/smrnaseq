
nextflow_pipeline {

    name "Test Workflow main.nf - test_umi"
    script "main.nf"
    profile "test_umi,ci"
    tag "umi"
    tag "pipeline"

    test("test_umi") {

        when {
            params {
                outdir = "$outputDir"
            }
        }

        then {
            assertAll(
                { assert workflow.success},
                { assert snapshot(
                    // Number of successful tasks
                    workflow.trace.succeeded().size(),
                    // pipeline versions.yml file for multiqc from which Nextflow version is removed because we test pipelines on multiple Nextflow versions
                    removeNextflowVersion("$outputDir/pipeline_info/nf_core_smrnaseq_software_mqc_versions.yml")
                ).match() },

                { assert snapshot(
                    path("$outputDir/mirna_quant/bam/mature/SRX8195118_SRR11631014_mature.sorted.stats"),
                    path("$outputDir/mirna_quant/bam/mature/SRX8195118_SRR11631014_mature.sorted.flagstat"),
                    path("$outputDir/mirna_quant/bam/mature/SRX8195118_SRR11631014_mature.sorted.idxstats"),
                    path("$outputDir/mirna_quant/bam/mature/SRX8195117_SRR11631013_mature.sorted.stats"),
                    path("$outputDir/mirna_quant/bam/mature/SRX8195117_SRR11631013_mature.sorted.flagstat"),
                    path("$outputDir/mirna_quant/bam/mature/SRX8195117_SRR11631013_mature.sorted.idxstats"),
                    path("$outputDir/mirna_quant/bam/hairpin/SRX8195117_SRR11631013_mature_hairpin.sorted.idxstats"),
                    path("$outputDir/mirna_quant/bam/hairpin/SRX8195117_SRR11631013_mature_hairpin.sorted.flagstat"),
                    path("$outputDir/mirna_quant/bam/hairpin/SRX8195117_SRR11631013_mature_hairpin.sorted.stats"),
                    path("$outputDir/mirna_quant/bam/hairpin/SRX8195118_SRR11631014_mature_hairpin.sorted.stats"),
                    path("$outputDir/mirna_quant/bam/hairpin/SRX8195118_SRR11631014_mature_hairpin.sorted.idxstats"),
                    path("$outputDir/mirna_quant/bam/hairpin/SRX8195118_SRR11631014_mature_hairpin.sorted.flagstat"),
                ).match("mirna_quant_bam") },

                { assert snapshot(
                    path("$outputDir/mirna_quant/edger_qc/hairpin_logtpm.txt").exists(),
                    path("$outputDir/mirna_quant/edger_qc/hairpin_logtpm.csv").exists(),
                    path("$outputDir/mirna_quant/edger_qc/hairpin_counts.csv").exists(),
                    path("$outputDir/mirna_quant/edger_qc/hairpin_unmapped_read_counts.txt").exists(),
                    path("$outputDir/mirna_quant/edger_qc/hairpin_normalized_CPM.txt").exists(),
                    path("$outputDir/mirna_quant/edger_qc/mature_logtpm.csv").exists(),
                    path("$outputDir/mirna_quant/edger_qc/mature_normalized_CPM.txt").exists(),
                    path("$outputDir/mirna_quant/edger_qc/mature_unmapped_read_counts.txt").exists(),
                    path("$outputDir/mirna_quant/edger_qc/mature_counts.csv").exists(),
                    path("$outputDir/mirna_quant/edger_qc/mature_logtpm.txt").exists()
                ).match("mirna_quant_edger_qc") },

                { assert snapshot(
                    path("$outputDir/mirna_quant/mirtop/joined_samples_mirtop.tsv").exists(),
                    path("$outputDir/mirna_quant/mirtop/mirna.tsv").exists(),
                ).match("mirna_quant_mirtop") },

                { assert snapshot(
                    path("$outputDir/mirtrace/SRX8195117_SRR11631013/mirtrace-report.html").exists(),
                    path("$outputDir/mirtrace/SRX8195117_SRR11631013/mirtrace-stats-contamination_detailed.tsv"),
                    path("$outputDir/mirtrace/SRX8195117_SRR11631013/mirtrace-stats-contamination_basic.tsv"),
                    path("$outputDir/mirtrace/SRX8195117_SRR11631013/mirtrace-stats-length.tsv"),
                    path("$outputDir/mirtrace/SRX8195117_SRR11631013/mirtrace-stats-qcstatus.tsv"),
                    path("$outputDir/mirtrace/SRX8195117_SRR11631013/mirtrace-stats-mirna-complexity.tsv"),
                    path("$outputDir/mirtrace/SRX8195117_SRR11631013/mirtrace-stats-phred.tsv"),
                    path("$outputDir/mirtrace/SRX8195117_SRR11631013/mirtrace-stats-rnatype.tsv"),
                    path("$outputDir/mirtrace/SRX8195118_SRR11631014/mirtrace-report.html").exists(),
                    path("$outputDir/mirtrace/SRX8195118_SRR11631014/mirtrace-stats-contamination_detailed.tsv"),
                    path("$outputDir/mirtrace/SRX8195118_SRR11631014/mirtrace-stats-contamination_basic.tsv"),
                    path("$outputDir/mirtrace/SRX8195118_SRR11631014/mirtrace-stats-length.tsv"),
                    path("$outputDir/mirtrace/SRX8195118_SRR11631014/mirtrace-stats-qcstatus.tsv"),
                    path("$outputDir/mirtrace/SRX8195118_SRR11631014/mirtrace-stats-mirna-complexity.tsv"),
                    path("$outputDir/mirtrace/SRX8195118_SRR11631014/mirtrace-stats-phred.tsv"),
                    path("$outputDir/mirtrace/SRX8195118_SRR11631014/mirtrace-stats-rnatype.tsv")
                ).match("mirtrace") },

                { assert snapshot(
                    path("$outputDir/genome_quant/bam/SRX8195118_SRR11631014_mature_hairpin_genome.sorted.flagstat"),
                    path("$outputDir/genome_quant/bam/SRX8195117_SRR11631013_mature_hairpin_genome.sorted.flagstat"),
                    path("$outputDir/genome_quant/bam/SRX8195117_SRR11631013_mature_hairpin_genome.sorted.idxstats"),
                    path("$outputDir/genome_quant/bam/SRX8195118_SRR11631014_mature_hairpin_genome.sorted.idxstats"),
                    path("$outputDir/genome_quant/bam/SRX8195118_SRR11631014_mature_hairpin_genome.sorted.stats"),
                    path("$outputDir/genome_quant/bam/SRX8195117_SRR11631013_mature_hairpin_genome.sorted.stats")
                ).match("genome_quant_bam") },

                { assert snapshot(
                    path("$outputDir/multiqc/multiqc_report.html").exists()
                ).match("multiqc") },

                { assert snapshot(
                    path("$outputDir/multiqc/multiqc_data/fastqc-status-check-heatmap.txt"),
                    path("$outputDir/multiqc/multiqc_data/fastp_filtered_reads_plot.txt"),
                    path("$outputDir/multiqc/multiqc_data/fastqc-1_sequence_counts_plot.txt"),
                    path("$outputDir/multiqc/multiqc_data/mirtrace_complexity_plot.txt"),
                    path("$outputDir/multiqc/multiqc_data/fastqc-1_per_sequence_gc_content_plot_Percentages.txt"),
                    path("$outputDir/multiqc/multiqc_data/multiqc_citations.txt"),
                    path("$outputDir/multiqc/multiqc_data/samtools-stats-dp.txt"),
                    path("$outputDir/multiqc/multiqc_data/fastqc_sequence_length_distribution_plot.txt"),
                    path("$outputDir/multiqc/multiqc_data/fastp-seq-content-n-plot_Read_1_Before_filtering.txt"),
                    path("$outputDir/multiqc/multiqc_data/fastqc-1_sequence_duplication_levels_plot.txt"),
                    path("$outputDir/multiqc/multiqc_data/fastqc-1_per_base_sequence_quality_plot.txt"),
                    path("$outputDir/multiqc/multiqc_data/multiqc_general_stats.txt"),
                    path("$outputDir/multiqc/multiqc_data/fastqc-1_per_base_n_content_plot.txt"),
                    path("$outputDir/multiqc/multiqc_data/fastqc_per_base_n_content_plot.txt"),
                    path("$outputDir/multiqc/multiqc_data/fastp-seq-quality-plot_Read_1_After_filtering.txt"),
                    path("$outputDir/multiqc/multiqc_data/fastqc_per_sequence_quality_scores_plot.txt"),
                    path("$outputDir/multiqc/multiqc_data/mirtrace_qc_plot.txt"),
                    path("$outputDir/multiqc/multiqc_data/fastqc-1_per_sequence_quality_scores_plot.txt"),
                    path("$outputDir/multiqc/multiqc_data/mirtrace_length_plot.txt"),
                    path("$outputDir/multiqc/multiqc_data/fastqc-1-status-check-heatmap.txt"),
                    path("$outputDir/multiqc/multiqc_data/fastqc_sequence_counts_plot.txt"),
                    path("$outputDir/multiqc/multiqc_data/mirtrace_rna_categories_plot.txt"),
                    path("$outputDir/multiqc/multiqc_data/fastp-seq-quality-plot_Read_1_Before_filtering.txt"),
                    path("$outputDir/multiqc/multiqc_data/samtools_alignment_plot.txt"),
                    path("$outputDir/multiqc/multiqc_data/fastqc_per_base_sequence_quality_plot.txt"),
                    path("$outputDir/multiqc/multiqc_data/mirtop_read_count_plot.txt"),
                    path("$outputDir/multiqc/multiqc_data/fastp-seq-content-n-plot_Read_1_After_filtering.txt"),
                    path("$outputDir/multiqc/multiqc_data/mirtop_unique_read_count_plot.txt"),
                    path("$outputDir/multiqc/multiqc_data/mirtop_mean_read_count_plot.txt"),
                    path("$outputDir/multiqc/multiqc_data/mirtrace_contamination_check_plot.txt"),
                    path("$outputDir/multiqc/multiqc_data/fastqc_adapter_content_plot.txt"),
                    path("$outputDir/multiqc/multiqc_data/fastqc_sequence_duplication_levels_plot.txt"),
                    path("$outputDir/multiqc/multiqc_data/fastqc_per_sequence_gc_content_plot_Percentages.txt"),
                    path("$outputDir/multiqc/multiqc_data/fastqc-1_per_sequence_gc_content_plot_Counts.txt"),
                    path("$outputDir/multiqc/multiqc_data/fastqc-1_adapter_content_plot.txt"),
                    path("$outputDir/multiqc/multiqc_data/fastp-seq-content-gc-plot_Read_1_Before_filtering.txt"),
                    path("$outputDir/multiqc/multiqc_data/fastqc_per_sequence_gc_content_plot_Counts.txt"),
                    path("$outputDir/multiqc/multiqc_data/multiqc_sources.txt").exists(),
                    path("$outputDir/multiqc/multiqc_data/fastp-seq-content-gc-plot_Read_1_After_filtering.txt")
                ).match("multiqc_multiqc_data") }
            )
        }
    }
}
